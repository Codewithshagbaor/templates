{% extends 'base.html' %}
{% load static %}
{% block title %}{{room.title}} - MediconnectExtra{% endblock %}
{% block content %}
{% if request.user.is_authenticated %}
<link href="https://vjs.zencdn.net/8.5.2/video-js.css" rel="stylesheet" />
<link href="https://unpkg.com/@videojs/themes@1/dist/city/index.css" rel="stylesheet">
<div class="slider-area">
  <div class="slider-height2 slider-bg2 d-flex align-items-center">
  </div>
</div>
  <div class="app-container">
    {% if request.user == room.admin %}
    <!-- Add the confirmation dialog -->
    <div id="overlay" class="overlay"></div>
  <div id="confirmationDialog" class="popup-dialog">
    <p>Do you want to end the meeting and save the details?</p>
    <button id="confirmEndMeetingButton">Yes</button>
    <button id="cancelEndMeetingButton">Cancel</button>
  </div>
  {% endif %}
  {% if request.user == room.admin %}
    <div class="sidebar left-sidebar">
      
      <div class="participants">
        <div id="activeUsersCount">Number of Active Users: Loading...</div>
        <div class="participants-scroll">
          <ul id="participantsList">
          </ul>
        </div>
        
      </div>
      
      <div id="download-container" style="width: 50px; height: auto; align-items: center; justify-content: center;"></div>
    </div>
    {% endif %}
    <div class="video-container">
      <video id="videoPlayer" controls class="video-container"></video>
    </div>


    <div class="sidebar right-sidebar">
      <div class="chat">
        <h2>Comments</h2>
        <div id="messages" class="chat-scroll">
          {% for msg in messages %}
          <div class="message">
            <div class="user-info">
              <img
                src="{{msg.user.user_profile.profile_pic.url}}"
                alt="User">
              <span class="user-name">{{msg.user.first_name}}</span>
            </div>
            <div class="message-content">{{msg.text}}</div>
          </div>
          {% endfor %}
        </div>
      </div>
      <br>
        <div id="comment-form">
          <div class="feedback-container">
            <textarea placeholder="Enter your Comment" class="single-textarea" required style="border: 1px solid #cbd5e0; border-radius: 0.25rem;" id="inputMsg"></textarea><br>
            <button type="submit" class="genric-btn success radiuss" onclick="sendMessage();">Submit</button>
          </div>
        </div>
    </div>
  </div>
  <div class="camera-controls">
    <div class="link link_left">
      <span id="date-time"></span> | {{room.room_id}}
      <a onclick="copyToClipboard()">
        <svg fill="none" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
          <g stroke="#292d32" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5">
            <path d="m16 12.9v4.2c0 3.5-1.4 4.9-4.9 4.9h-4.2c-3.5 0-4.9-1.4-4.9-4.9v-4.2c0-3.5 1.4-4.9 4.9-4.9h4.2c3.5 0 4.9 1.4 4.9 4.9z" />
            <path d="m22 6.9v4.2c0 3.5-1.4 4.9-4.9 4.9h-1.1v-3.1c0-3.5-1.4-4.9-4.9-4.9h-3.1v-1.1c0-3.5 1.4-4.9 4.9-4.9h4.2c3.5 0 4.9 1.4 4.9 4.9z" />
          </g>
        </svg>
      </a>        
    </div>
    <div class="notification" id="notification">Copied to clipboard</div>

    <div class="link link_center">
      {% if request.user == room.admin %}
      <div class="tooltip">
        <a type="button" class="feedback-button" onclick="muteVideo();" id="videoBtn">
          <svg fill="none" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
            <g id="videobtncolour" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5">
              <path
                d="m12.53 20.4201h-6.32c-3.16 0-4.21-2.1-4.21-4.21v-8.42002c0-3.16 1.05-4.21 4.21-4.21h6.32c3.16 0 4.21 1.05 4.21 4.21v8.42002c0 3.16-1.06 4.21-4.21 4.21z" />
              <path
                d="m19.52 17.0999-2.78-1.95v-6.31001l2.78-1.95c1.36-.95 2.48-.37 2.48 1.3v7.62001c0 1.67-1.12 2.25-2.48 1.29z" />
              <path
                d="m11.5 11c.8284 0 1.5-.6716 1.5-1.5 0-.82843-.6716-1.5-1.5-1.5s-1.5.67157-1.5 1.5c0 .8284.6716 1.5 1.5 1.5z" />
            </g>
          </svg>
        </a>
        <span class="tooltip-text">Video</span>
      </div>
      <div class="tooltip">
        <a type="button" class="feedback-button" onclick="muteAudio();" id="audioBtn">
          <svg fill="none" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
            <g id="audiobtncolour">
              <path
                d="m12 16.25c-2.62 0-4.75-2.13-4.75-4.75v-5.5c0-2.62 2.13-4.75 4.75-4.75s4.75 2.13 4.75 4.75v5.5c0 2.62-2.13 4.75-4.75 4.75zm0-13.5c-1.79 0-3.25 1.46-3.25 3.25v5.5c0 1.79 1.46 3.25 3.25 3.25s3.25-1.46 3.25-3.25v-5.5c0-1.79-1.46-3.25-3.25-3.25z" />
              <path
                d="m11.9996 19.7499c-4.62999 0-8.39999-3.77-8.39999-8.4v-1.7c0-.41.34-.75.75-.75s.75.34.75.75v1.7c0 3.8 3.1 6.9 6.89999 6.9 3.8 0 6.9-3.1 6.9-6.9v-1.7c0-.41.34-.75.75-.75s.75.34.75.75v1.7c0 4.63-3.77 8.4-8.4 8.4z" />
              <path
                d="m13.3899 7.17982c-.08 0-.17-.01-.26-.04-.73-.27-1.53-.27-2.26 0-.39.14-.82-.06-.96002-.45-.14-.39.06-.82.45002-.96 1.06-.38 2.23-.38 3.29 0 .39.14.59.57.45.96-.12.3-.41.49-.71.49z" />
              <path
                d="m12.8001 9.29982c-.07 0-.13-.01-.2-.03-.4-.11-.81-.11-1.21 0s-.81-.13-.92-.53c-.11-.39.13-.8.53-.91.65-.18 1.35-.18 2 0 .4.11.64.52.53.92-.09.33-.4.55-.73.55z" />
              <path d="m12 22.75c-.41 0-.75-.34-.75-.75v-3c0-.41.34-.75.75-.75s.75.34.75.75v3c0 .41-.34.75-.75.75z" />
            </g>
          </svg>
        </a>
        <span class="tooltip-text">Audio</span>
    </div>
    <div class="tooltip">
      <a type="button" class="feedback-button" onclick="shareScreen();" id="screen-btn">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-screen-share" width="24"
          height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round"
          stroke-linejoin="round">
          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
          <path d="M21 12v3a1 1 0 0 1 -1 1h-16a1 1 0 0 1 -1 -1v-10a1 1 0 0 1 1 -1h9" />
          <line x1="7" y1="20" x2="17" y2="20" />
          <line x1="9" y1="16" x2="9" y2="20" />
          <line x1="15" y1="16" x2="15" y2="20" />
          <path d="M17 4h4v4" />
          <path d="M16 9l5 -5" />
        </svg>
      </a>
      <span class="tooltip-text">Share Screen</span>
    </div>
    <div class="tooltip">
        <a type="button" class="feedback-button" onclick="toggleRecording();" id="recordBtn">
          <svg fill="none" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path id="recordIcon" d="m11.9688 2c-5.52005 0-10.00005 4.48-10.00005 10s4.48 10 10.00005 10c5.52 0 10-4.48 10-10s-4.47-10-10-10zm.0299 14.23c-2.33995 0-4.22995-1.89-4.22995-4.23s1.89-4.23 4.22995-4.23c2.34 0 4.23 1.89 4.23 4.23s-1.89 4.23-4.23 4.23z" fill="#292d32"/></svg>
        </a>
        <span class="tooltip-text">Record</span>
    </div>
      {% else %}
      <div id="screen-btn">

      </div>
      {% endif %}
      {% if request.user == room.admin %}
      <div class="tooltip">
        <a type="button" class="feedback-button" id="end-meeting" data-room-id="{{ room.room_id }}">
          <svg fill="none" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"
            xmlns:xlink="http://www.w3.org/1999/xlink">
            <mask id="a" height="2" maskUnits="userSpaceOnUse" width="15" x="8" y="11">
              <path clip-rule="evenodd" d="m8.99609 11.2501h13.54091v1.5h-13.54091z" fill="#fff" fill-rule="evenodd" />
            </mask>
            <mask id="b" height="8" maskUnits="userSpaceOnUse" width="5" x="18" y="8">
              <path clip-rule="evenodd" d="m18.1096 8.33539h4.4274v7.33071h-4.4274z" fill="#fff" fill-rule="evenodd" />
            </mask>
            <path clip-rule="evenodd"
              d="m11.3192 22.0001h-4.88596c-2.444 0-4.433-1.989-4.433-4.435v-11.12898c0-2.446 1.989-4.436 4.433-4.436h4.87496c2.446 0 4.436 1.99 4.436 4.436v.932c0 .414-.336.75-.75.75s-.75-.336-.75-.75v-.932c0-1.62-1.317-2.936-2.936-2.936h-4.87496c-1.617 0-2.933 1.316-2.933 2.936v11.12898c0 1.619 1.316 2.935 2.933 2.935h4.88596c1.612 0 2.925-1.312 2.925-2.924v-.943c0-.414.336-.75.75-.75s.75.336.75.75v.943c0 2.44-1.986 4.424-4.425 4.424z"
              fill="#000" fill-rule="evenodd" />
            <g mask="url(#a)">
              <path clip-rule="evenodd"
                d="m21.7871 12.7501h-12.04101c-.414 0-.75-.336-.75-.75s.336-.75.75-.75h12.04101c.414 0 .75.336.75.75s-.336.75-.75.75z"
                fill="#000" fill-rule="evenodd" />
            </g>
            <g mask="url(#b)">
              <path clip-rule="evenodd"
                d="m18.8594 15.6661c-.192 0-.385-.073-.531-.221-.292-.294-.291-.768.002-1.06l2.394-2.385-2.394-2.38396c-.293-.292-.295-.766-.002-1.06.292-.294.766-.294 1.06-.002l2.928 2.91496c.142.14.221.332.221.531s-.079.391-.221.531l-2.928 2.916c-.146.146-.338.219-.529.219z"
                fill="#000" fill-rule="evenodd" />
            </g>
          </svg>
        </a>
        <span class="tooltip-text">End</span>
      </div>

      {% else %}
      <div class="tooltip">
        <a href="{% url 'program_list' %}" type="button" class="feedback-button">
          <svg fill="none" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"
            xmlns:xlink="http://www.w3.org/1999/xlink">
            <mask id="a" height="2" maskUnits="userSpaceOnUse" width="15" x="8" y="11">
              <path clip-rule="evenodd" d="m8.99609 11.2501h13.54091v1.5h-13.54091z" fill="#fff" fill-rule="evenodd" />
            </mask>
            <mask id="b" height="8" maskUnits="userSpaceOnUse" width="5" x="18" y="8">
              <path clip-rule="evenodd" d="m18.1096 8.33539h4.4274v7.33071h-4.4274z" fill="#fff" fill-rule="evenodd" />
            </mask>
            <path clip-rule="evenodd"
              d="m11.3192 22.0001h-4.88596c-2.444 0-4.433-1.989-4.433-4.435v-11.12898c0-2.446 1.989-4.436 4.433-4.436h4.87496c2.446 0 4.436 1.99 4.436 4.436v.932c0 .414-.336.75-.75.75s-.75-.336-.75-.75v-.932c0-1.62-1.317-2.936-2.936-2.936h-4.87496c-1.617 0-2.933 1.316-2.933 2.936v11.12898c0 1.619 1.316 2.935 2.933 2.935h4.88596c1.612 0 2.925-1.312 2.925-2.924v-.943c0-.414.336-.75.75-.75s.75.336.75.75v.943c0 2.44-1.986 4.424-4.425 4.424z"
              fill="#000" fill-rule="evenodd" />
            <g mask="url(#a)">
              <path clip-rule="evenodd"
                d="m21.7871 12.7501h-12.04101c-.414 0-.75-.336-.75-.75s.336-.75.75-.75h12.04101c.414 0 .75.336.75.75s-.336.75-.75.75z"
                fill="#000" fill-rule="evenodd" />
            </g>
            <g mask="url(#b)">
              <path clip-rule="evenodd"
                d="m18.8594 15.6661c-.192 0-.385-.073-.531-.221-.292-.294-.291-.768.002-1.06l2.394-2.385-2.394-2.38396c-.293-.292-.295-.766-.002-1.06.292-.294.766-.294 1.06-.002l2.928 2.91496c.142.14.221.332.221.531s-.079.391-.221.531l-2.928 2.916c-.146.146-.338.219-.529.219z"
                fill="#000" fill-rule="evenodd" />
            </g>
          </svg>
        </a>
        <span class="tooltip-text">Leave</span>
      </div>

      {% endif %}
    </div>
    <div class="link link_right">
      {% if request.user == room.admin %}
      <div id="timerDisplay">00:00</div>
      {% endif %}
      <div class="tooltip">
        <a href="" type="button" class="feedback-button">
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-info-circle" width="24"
          height="24"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path d="M6.71275 10.6736C7.16723 8.15492 9.38539 6.25 12.0437 6.25C13.6212 6.25 15.0431 6.9209 16.0328 7.9907C16.3141 8.29476 16.2956 8.76927 15.9915 9.05055C15.6875 9.33183 15.213 9.31337 14.9317 9.0093C14.2154 8.23504 13.1879 7.75 12.0437 7.75C10.2056 7.75 8.66974 9.00212 8.24452 10.6853L8.48095 10.4586C8.77994 10.172 9.25471 10.182 9.54137 10.4809C9.82804 10.7799 9.81805 11.2547 9.51905 11.5414L7.89662 13.0969C7.74932 13.2381 7.55084 13.3133 7.34695 13.3049C7.14306 13.2966 6.95137 13.2056 6.81608 13.0528L5.43852 11.4972C5.16391 11.1871 5.19267 10.7131 5.50277 10.4385C5.81286 10.1639 6.28686 10.1927 6.56148 10.5028L6.71275 10.6736Z" fill="#1C274C"></path> <path d="M16.6485 10.6959C16.8523 10.704 17.044 10.7947 17.1795 10.9472L18.5607 12.5019C18.8358 12.8115 18.8078 13.2856 18.4981 13.5607C18.1885 13.8358 17.7144 13.8078 17.4393 13.4981L17.2841 13.3234C16.8295 15.8458 14.6011 17.7509 11.9348 17.7509C10.3635 17.7509 8.94543 17.0895 7.95312 16.0322C7.66966 15.7302 7.68472 15.2555 7.98675 14.9721C8.28879 14.6886 8.76342 14.7037 9.04688 15.0057C9.76546 15.7714 10.792 16.2509 11.9348 16.2509C13.7819 16.2509 15.322 14.9991 15.7503 13.3193L15.5195 13.5409C15.2208 13.8278 14.746 13.8183 14.4591 13.5195C14.1721 13.2208 14.1817 12.746 14.4805 12.4591L16.0993 10.9044C16.2464 10.7631 16.4447 10.6878 16.6485 10.6959Z" fill="#1C274C"></path> <path fill-rule="evenodd" clip-rule="evenodd" d="M11.9426 1.25C9.63423 1.24999 7.82519 1.24998 6.4137 1.43975C4.96897 1.63399 3.82895 2.03933 2.93414 2.93414C2.03933 3.82895 1.63399 4.96897 1.43975 6.41371C1.24998 7.82519 1.24999 9.63423 1.25 11.9426V12.0574C1.24999 14.3658 1.24998 16.1748 1.43975 17.5863C1.63399 19.031 2.03933 20.1711 2.93414 21.0659C3.82895 21.9607 4.96897 22.366 6.4137 22.5603C7.82519 22.75 9.63423 22.75 11.9426 22.75H12.0574C14.3658 22.75 16.1748 22.75 17.5863 22.5603C19.031 22.366 20.1711 21.9607 21.0659 21.0659C21.9607 20.1711 22.366 19.031 22.5603 17.5863C22.75 16.1748 22.75 14.3658 22.75 12.0574V11.9426C22.75 9.63423 22.75 7.82519 22.5603 6.41371C22.366 4.96897 21.9607 3.82895 21.0659 2.93414C20.1711 2.03933 19.031 1.63399 17.5863 1.43975C16.1748 1.24998 14.3658 1.24999 12.0574 1.25H11.9426ZM3.9948 3.9948C4.56445 3.42514 5.33517 3.09825 6.61358 2.92637C7.91356 2.75159 9.62177 2.75 12 2.75C14.3782 2.75 16.0864 2.75159 17.3864 2.92637C18.6648 3.09825 19.4355 3.42514 20.0052 3.9948C20.5749 4.56445 20.9018 5.33517 21.0736 6.61358C21.2484 7.91356 21.25 9.62178 21.25 12C21.25 14.3782 21.2484 16.0864 21.0736 17.3864C20.9018 18.6648 20.5749 19.4355 20.0052 20.0052C19.4355 20.5749 18.6648 20.9018 17.3864 21.0736C16.0864 21.2484 14.3782 21.25 12 21.25C9.62177 21.25 7.91356 21.2484 6.61358 21.0736C5.33517 20.9018 4.56445 20.5749 3.9948 20.0052C3.42514 19.4355 3.09825 18.6648 2.92637 17.3864C2.75159 16.0864 2.75 14.3782 2.75 12C2.75 9.62178 2.75159 7.91356 2.92637 6.61358C3.09825 5.33517 3.42514 4.56445 3.9948 3.9948Z" fill="#1C274C"></path> </g></svg>
        </a>
        <span class="tooltip-text" style="visibility: visible !important; opacity: 1 !important;">Reconnect</span>
      </div>
    </div>

  </div>
  {% if request.user == room.admin %}
  <script>
    function updateTimerDisplay(startTime, meetingEnded) {
      if (!meetingEnded) {
        const currentTime = new Date();
        const elapsedTimeInSeconds = Math.floor((currentTime - startTime) / 1000);
        const minutes = Math.floor(elapsedTimeInSeconds / 60);
        const seconds = elapsedTimeInSeconds % 60;
    
        const formattedMinutes = minutes.toString().padStart(2, '0');
        const formattedSeconds = seconds.toString().padStart(2, '0');
    
        document.getElementById("timerDisplay").textContent = `Meeting Duration: ${formattedMinutes}:${formattedSeconds}`;
      }
    }
    
    document.getElementById("end-meeting").addEventListener("click", (event) => {
      const room_id = event.target.getAttribute("data-room-id"); // Get the room_id
    
      let startTime = new Date();
      let meetingStarted = true;
      let meetingEnded = false;
    
      // Check if the start time is stored in a cookie
      const storedStartTime = getCookie(`meetingStartTime_${room_id}`);
      if (storedStartTime) {
        startTime = new Date(storedStartTime);
        meetingStarted = true;
      }
    
      if (!meetingStarted) {
        // Store the start time in a cookie
        document.cookie = `meetingStartTime_${room_id}=${startTime.toISOString()}; path=/`;
      }
    
      // Show the overlay and popup dialog
      document.getElementById("overlay").style.display = "block";
      document.getElementById("confirmationDialog").style.display = "block";
    
      // Hide the confirmation dialog
      document.getElementById("cancelEndMeetingButton").addEventListener("click", () => {
        document.getElementById("confirmationDialog").style.display = "none";
        document.getElementById("overlay").style.display = "none";
      });
    
      document.getElementById("confirmEndMeetingButton").addEventListener("click", async () => {
        if (!meetingEnded) {
          meetingEnded = true;
          const durationMinutes = calculateElapsedTime(startTime);
    
          // Calculate duration as a Date object
          const duration = new Date(durationMinutes * 60 * 1000);
    
          // Update the timer display
          document.getElementById("timerDisplay").textContent = `Meeting Duration: ${durationMinutes} minutes`;
    
          // Make an AJAX call to save the meeting duration
          try {
            const response = await fetch(`/save_meeting_duration/${room_id}/${durationMinutes}/`, {
              method: 'POST', // Use POST method to send data
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken') // Make sure to include CSRF token
              },
              body: JSON.stringify({ duration: duration.toISOString() }) // Convert duration to ISO string
            });
            const data = await response.json();
            console.log(data.message); // You can display a success message to the user
    
            // Redirect the user after saving
            window.location.href = "{% url 'program_list' %}";
          } catch (error) {
            console.error("Error:", error);
          }
        }
    
        // Hide the confirmation dialog
        document.getElementById("confirmationDialog").style.display = "none";
      });
    });
    function calculateElapsedTime(startTime) {
const currentTime = new Date();
const elapsedTimeInSeconds = Math.floor((currentTime - startTime) / 1000); // in seconds
return Math.floor(elapsedTimeInSeconds / 60); // Return duration in minutes
}

    // Function to retrieve CSRF token
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
    
    // Start updating the timer display every second
    setInterval(() => {
const room_id = document.getElementById("end-meeting").getAttribute("data-room-id"); // Get the room_id
const storedStartTime = getCookie(`meetingStartTime_${room_id}`);
const meetingStarted = storedStartTime !== null;
updateTimerDisplay(new Date(storedStartTime), !meetingStarted);
}, 1000);

    </script>

    
  {% endif %}
<script src="https://cdn.WebRTC-Experiment.com/RecordRTC.js"></script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>

<script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
<script type="text/JavaScript" src=" https://MomentJS.com/downloads/moment.js"></script>
<script>
function updateTime() {
  document.getElementById('date-time').innerText = moment(Date.now()).format('Do MMMM, YYYY h:mm a');
}
setInterval(updateTime, 1000);

let myDetails = {
  "id": '{{request.user.user_profile.unique_id}}',
  "name": '{% if user.first_name %}{{user.first_name}}{% else %}{{user.username}}{% endif %}',
  "profile_pic":'{{request.user.user_profile.profile_pic.url}}',
};
let chatSocket;
let onlineList = document.getElementById("participantsList");
let chatList = document.getElementById("messages");
let audioBtn = document.getElementById("audioBtn");
let videoBtn = document.getElementById("videoBtn");
let screenBtn = document.getElementById("screen-btn");
let localVideoStream;
let localScreenStream;
let localStream;
let call_to;
let peerConnection = {};
let remoteOffer;
let numVideos = 0;
let showVideo = true;
let playAudio = true;
let videoDialog = document.getElementById("video-div");
let videoElement;
let waitList = [];
let showScreen = false;
screenBtn.style.color = "red";

function getLocation() {
  if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(showPosition);
  } else {
      myPosition.innerHTML = "Geolocation is not supported by this browser.";
  }
}

// document.getElementById("location").style.display = "block";
function showPosition(position) {
  myPosition.style.display = "block";
  myPosition.innerHTML = "<i class='fas fa-map-marker-alt'></i> " + position.coords.latitude +
      ", " + position.coords.longitude;
}


let ICEconfig = {
  iceServers: [{
          urls: ["stun:bn-turn1.xirsys.com"]
      },
      {
          username: "WtJcHNTgNpN90FSvMVmZtWWVztiHEhbFfsdRyMS1f_PoMfbjWJSW_rVXiivC4VCOAAAAAGGZQvNhc2hpc2hzYXNtYWwx",
          credential: "6e26a8e4-4a32-11ec-8f0c-0242ac140004",
          urls: [
              "turn:bn-turn1.xirsys.com:80?transport=udp",
              "turn:bn-turn1.xirsys.com:3478?transport=udp",
              "turn:bn-turn1.xirsys.com:80?transport=tcp",
              "turn:bn-turn1.xirsys.com:3478?transport=tcp",
              "turns:bn-turn1.xirsys.com:443?transport=tcp",
              "turns:bn-turn1.xirsys.com:5349?transport=tcp"
          ]
      }
  ]
}
{% if request.user == room.admin %}
const mediaConstraints = {
  "video": true,
  audio: true
}
{% else %}
const mediaConstraints = {
  "video": false,
  audio: false
}
{% endif %}
const screenConstraints = {
  "video": {
      mediaSource: "screen"
  },
  audio: {
      echoCancellation: true,
      noiseSuppression: true
  }
}

let iceCandidatesList = {};
let conn = [];

function play() {
  var audio = new Audio('https://2u039f-a.akamaihd.net/downloads/ringtones/files/mp3/xperia-artic-54206.mp3');
  audio.play();
}

function playEnterRoom() {
  var audio = new Audio('https://www.setasringtones.com/storage/ringtones/9/aa925f907affb2e0998254d360689a2f.mp3');
  audio.play();
}

function accessMedia(user, screen = false) {
  console.log("access media " + myDetails.id)
  console.log(mediaConstraints)
  return navigator.mediaDevices.getUserMedia(mediaConstraints)
      .then(stream => {
          localVideoStream = stream;
          localStream = stream;
          muteAudio();
          muteVideo();
          onVideoAdd(user, localVideoStream);
      }).catch(function(error) {
          console.log(error)
      });
}

async function accessScreen(user) {
  console.log("access media " + myDetails.id)
  console.log(mediaConstraints)
  return navigator.mediaDevices.getDisplayMedia(screenConstraints)
      .then(stream => {
          localScreenStream = stream;
          localStream = stream;
          muteAudio(screen = false);
          muteVideo(screen = true);
          console.log(localScreenStream);
      }).catch(function(error) {
          console.log(error)
      });
}

function connectWebSocket() {
  var ws_scheme = window.location.protocol == "https:" ? "wss" : "ws";
  chatSocket = new WebSocket(ws_scheme + '://' + window.location.host + '/ws/chat/{{room.room_id}}/');
  console.log("Websocket connected");

  chatSocket.onopen = event => {
      chatSocket.send(JSON.stringify({
          "type": "login",
          "to": myDetails,
          "from": myDetails
      }));

      accessMedia(myDetails).then(
          bool => {
              playEnterRoom();
              chatSocket.send(JSON.stringify({
                  "type": "joiner",
                  "to": "all",
                  "from": myDetails,
              }));
          })

  }

  chatSocket.onmessage = async (e) => {
      const data = JSON.parse(e.data);
      console.log(data);

      let type = data.type;
      let user = data.from;
      if (data.to == "all") {
          if (type == "online_traffic") {
              let action = data.message;
              if (action == "remove") {
                  var elem = document.getElementById(user.id);
                  if (elem) {
                      elem.parentNode.removeChild(elem);
                  }
              } else if (action == "add") {
                if (!document.getElementById(user.id)){
                  onlineList.innerHTML +=`
                  <li id='${user.id}'>
                    <img src="${user.profile_pic}" alt="${user.name}">
                    <span class="participant-name">${user.name}</span>
                  </li>`;
                }
                  
              }
          }
          if (type == "joiner" && user.id != myDetails.id) {
              iceCandidatesList[user.id] = [];
              await call(user);
          }
      } else if (data.to.id == myDetails.id) {
          if (type == "success_join") {
              iceCandidatesList[user.id] = [];
              call(user);
          } else if (type == "offer") {
              iceCandidatesList[user.id] = [];
              console.log("Receiving call from " + user);
              await handleIncomingcall(user, data);
          } else if (type == "answer") {
              console.log("Call answered");
              peerConnection[user.id].pc.setRemoteDescription(data.answer);
          } else if (type == "candidate") {
              console.log("ICE candidate received");
              handleIncomingICEcandidate(user, data);
          }
      } else {
          if (type == "chat_message") {
              chatList.innerHTML +=
              `<div class="message">
                <div class="user-info">
                  <img
                    src="${user.profile_pic}"
                    alt="User">
                  <span class="user-name">${user.name}</span>
                </div>
                <div class="message-content">${data.message}</div>
              </div>`
          }
      }
  }
  }


if (chatSocket) {
  chatSocket.onclose = (e) => {
      alert("Socket disconnected");
      connectWebSocket();
  }
}


function sendSocket(data, to, from) {
  if (chatSocket) {
      data.to = to;
      data.from = from;
      chatSocket.send(JSON.stringify(
          data
      ));
  } else {
      console.log("Chat socket not connected")
  }
}
connectWebSocket();

function handleIncomingICEcandidate(user, data) {
  if (peerConnection[user.id] && data.candidate) {
      peerConnection[user.id].pc.addIceCandidate(new RTCIceCandidate(data.candidate));
  } else {
      console.log("RTC peer connection not set");
      iceCandidatesList[user.id].push(data.candidate);
  }
}

async function handleIncomingcall(user, data) {
  await createRTCPeerConnection(user);
  await createAndSendAnswer(user, data.offer);
}

function manageSocket() {
  if (activeBtn.checked) {
      connectWebSocket();
  } else {
      if (chatSocket) {
          chatSocket.close();
          console.log("Socket closed")
      } else {
          console.log("Socket not connected");
      }
  }
}


function createAndSendAnswer(user, remoteOffer) {
  console.log("hello")
  peerConnection[user.id].pc.setRemoteDescription(new RTCSessionDescription(remoteOffer));
  peerConnection[user.id].pc.createAnswer((answer) => {
      peerConnection[user.id].pc.setLocalDescription(new RTCSessionDescription(answer));
      sendSocket({
          type: "answer",
          answer: answer
      }, user, myDetails)
  }, error => {
      console.log(error);
  })
}

async function createAndSendOffer(user) {
  console.log("offer true")
  peerConnection[user.id].pc.createOffer((offer) => {
      console.log("hello")
      peerConnection[user.id].pc.setLocalDescription(new RTCSessionDescription(offer));
      sendSocket({
          type: "offer",
          offer: offer
      }, user, myDetails)
  }, (error) => {
      console.log("Error");
  });
}


async function call(user) {
  await createRTCPeerConnection(user);
  await createAndSendOffer(user);
}


async function createRTCPeerConnection(user, offer = false) {
  console.log("RTCPeerConnection connected");
  peerConnection[user.id] = {
      "name": user.name,
      "id": user.id,
      "pc": new RTCPeerConnection(ICEconfig)
  };
  // peerConnection = new RTCPeerConnection(null);
  if (localVideoStream) {
      localVideoStream.getTracks().forEach((track) => {
          peerConnection[user.id].pc.addTrack(track, localVideoStream);
      });
  }

  if (offer) {
      console.log("Creating Offer");
      peerConnection[user.id].pc.onnegotiationneeded = async (event) => createAndSendOffer(user);
  }
  peerConnection[user.id].pc.onicecandidate = (event) => handleICEcandidate(user, event);
  peerConnection[user.id].pc.ontrack = event => handleAddStream(user, event);
  return;
}


function handleAddStream(user, event) {
  console.log("track received");
  let stream = event.streams[0];
  onVideoAdd(user, stream);
}


function handleICEcandidate(user, event) {
  if (event.candidate == null)
      return;
  sendSocket({
      type: "candidate",
      candidate: event.candidate
  }, user, myDetails)
}


function muteAudio(screen = false) {
  if (localStream) {
      playAudio = !playAudio;
      if (playAudio) {
        const audiobtncolour = document.getElementById('audiobtncolour');
        audiobtncolour.style.fill  = "#2870de";
      } else {
        audiobtncolour.style.fill  = "red";
      }
      if (localStream.getAudioTracks()[0])
          localStream.getAudioTracks()[0].enabled = playAudio;
  }
}


function muteVideo(screen = false) {
  if (localStream) {
      showVideo = !showVideo;
      console.log(showVideo)
      if (showVideo) {
          if (showScreen){
              showScreen = false;
              localStream = localVideoStream;
              broadcast(localStream);
          }
          const videobtncolour = document.getElementById('videobtncolour');
          videobtncolour.style.fill  = "#2870de";
          onVideoAdd(myDetails, localVideoStream);
      } else {
        videobtncolour.style.fill  = "red";
      }
      localStream.getVideoTracks()[0].enabled = showVideo;
      
  } else {
      alert("Please allow video permission.");
  }
}


function broadcast(stream){
let track = stream.getVideoTracks()[0];
  for (let p in peerConnection) {
      let sender = peerConnection[p].pc.getSenders ? peerConnection[p].pc.getSenders().find(s => s.track && s.track.kind === track.kind) : false;

      if (sender) {
          console.log("hello " + track)
          sender.replaceTrack(track);
      }

  }
}

if (localScreenStream){
  localScreenStream.getVideoTracks()[0].onended = function () {
      screenBtn.style.color = "red";
};
}


async function shareScreen() {
if (showScreen){
      localScreenStream = await navigator.mediaDevices.getDisplayMedia();
      localStream = localScreenStream;
}
  else if (!localScreenStream) {
      localScreenStream = await navigator.mediaDevices.getDisplayMedia();
      localStream = localScreenStream;
  }
  muteVideo();
  localStream.getVideoTracks()[0].enabled = true;
  console.log(peerConnection);
  broadcast(localScreenStream);
  onVideoAdd(myDetails, localScreenStream);
  // senders.find(sender => sender.track.kind === 'video').replaceTrack(localScreenStream.getTracks()[0]);
  showScreen = true;
  screenBtn.style.color = "#2870de";
}


function replaceStreamTrack(stream) {
  for (let p in peerConnection) {
      if (p.pc) {
          p.pc.getSenders().forEach(function(sender) {
              console.log(sender);
              stream.getTracks.forEach(function(track) {
                  if (track == sender.track) {
                      p.pc.removeTrack(sender);
                  }
              })
          });
          createAndSendOffer({
              "name": pc.name,
              "id": pc.id
          });
      }
  }
}


function onVideoAdd(user, stream) {
  if (document.getElementById(`vid-${user.id}`)) {
      document.getElementById(`vid-${user.id}`).srcObject = stream;
  } else {
      var vidElement = document.createElement("video");
      vidElement.setAttribute('autoplay', '');
      vidElement.setAttribute('muted', '');
      vidElement.setAttribute('class', 'video-container video-js');
      vidElement.setAttribute('id', `vid-${user.id}`);
      vidElement.srcObject = stream;
      
      var videoContainer = document.querySelector(".video-container");
      videoContainer.innerHTML = ''; // Clear existing content
      videoContainer.appendChild(vidElement);
  }

  if (user.id == myDetails.id) {
      document.getElementById(`vid-${user.id}`).volume = 0;
  }
}



function sendMessage() {
  msg = document.getElementById("inputMsg").value;
  if (msg) {
      chatList.innerHTML +=
        `<div class="message">
          <div class="user-info">
            <img src="${myDetails.profile_pic}" alt="User">
            <span class="user-name">${myDetails.name}</span>
          </div>
          <div class="message-content">${msg}</div>
        </div>`
      sendSocket({
          "type": "chat_message",
          "message": msg
      }, "all", myDetails)
  }
  document.getElementById("inputMsg").value = "";
}

// Store connection information before refresh
function storeConnectionInfo() {
  // Store relevant connection information in local storage
  const connectionInfo = {
      peerConnections: peerConnection,
      localStream: localStream,
      showVideo: showVideo,
      playAudio: playAudio,
      showScreen: showScreen,
      localScreenStream: localScreenStream
  };
  localStorage.setItem('connectionInfo', JSON.stringify(connectionInfo));
}
// Event listener for page refresh
window.addEventListener('beforeunload', storeConnectionInfo);

// Event listener for page load


var input = document.getElementById("inputMsg");
input.addEventListener("keyup", function(event) {
  if (event.keyCode === 13) {
      event.preventDefault();
      sendMessage();
  }
});
let recorder; // Global variable to store the recorder instance
let isRecording = false;

function toggleRecording() {
const recordIcon = document.getElementById('recordIcon');

if (!isRecording) {
  startRecording();
  recordIcon.style.fill = 'red'; // Change the fill color to indicate recording
} else {
  stopRecording();
  recordIcon.style.fill = '#292d32'; // Change the fill color back to default
}
isRecording = !isRecording;
}


function startRecording() {
// Create a media stream that combines both video and audio
const combinedStream = new MediaStream();
localStream.getTracks().forEach(track => combinedStream.addTrack(track));

// Create a recorder instance
recorder = new RecordRTC(combinedStream, {
  type: 'video', // or 'audio' for audio-only recording
});

// Start recording
recorder.startRecording();
}

function stopRecording() {
if (recorder) {
  // Stop recording
  recorder.stopRecording(function() {
    const recordedBlob = recorder.getBlob();
    
    // Create a download link for the recorded file
    const downloadLink = document.createElement('a');
    downloadLink.href = URL.createObjectURL(recordedBlob);
    downloadLink.download = 'recorded-meeting.mp4'; // Change the filename as needed
    downloadLink.innerHTML = '<svg viewBox="0 0 72 72" xmlns="http://www.w3.org/2000/svg"><g style="fill:none;stroke:#000;stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:10;stroke-width:2"><path d="m36.0851 17.1466v18.8699"/><path d="m42.24 29.8951-6.14 6.14"/><path d="m29.91 29.8951 6.14 6.14"/><path d="m56.8961 54.9782h-41.8193c-1.65 0-3-1.35-3-3v-7.5762c0-1.65 1.35-3 3-3h41.8194c1.65 0 3 1.35 3 3v7.5762c-.0001 1.65-1.3501 3-3.0001 3z"/><circle cx="19.0173" cy="48.2886" r="2"/></g>Download </svg>';
    
    // Add the download link to the page
    const downloadContainer = document.getElementById('download-container');
    downloadContainer.appendChild(downloadLink);

    recorder = null;
  });
}
}

  </script>
<script>
function updateActiveUsersCount(roomId) {
  // Make an AJAX request to your Django backend
  fetch(`/path/to/your/endpoint/?room_id=${roomId}`)
      .then(response => response.json())
      .then(data => {
          // Update the content of the element with the active user count
          document.getElementById('activeUsersCount').innerText = 'Number of Active Users: ' + data.count;
      })
      .catch(error => {
          console.error('Error fetching active users count:', error);
      });
}

// Replace 'your_room_id' with the actual room ID from your page
const roomId = '{{room.room_id}}';

// Run the update function every 5 seconds
setInterval(() => updateActiveUsersCount(roomId), 5000);

</script>
</html>
<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background-color: #f0f0f0;
}

.camera-controls {
  display: flex;
  bottom: 0;
  left: 0;
  right: 0;
  background-color: #fff;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px;
  border: 1px solid #ccc;
  box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.1);
}

.app-container {
  display: flex;
  justify-content: center;
  align-items: stretch;
  height: 80vh;
  /* Adjusted height */
  margin-top: 20px;
  /* Added margin */
  margin-bottom: 20px;
  /* Added margin */
}
{% if request.user != room.admin %}
.sidebar {
  width: 500px;
  background-color: #fff;
  border-radius: 8px;
  padding: 20px;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
}
{% else %}
.sidebar {
  width: 300px;
  background-color: #fff;
  border-radius: 8px;
  padding: 20px;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
}
{% endif %}
.left-sidebar {
  margin-right: 20px;
}

.right-sidebar {
  margin-left: 20px;
}

.video-container {
  flex: 2 !important;
  /* Adjusted flex value */

  border-radius: 8px;
  padding: 20px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

#videoPlayer{
  max-width: 100% !important;
  max-height: 100% !important;
  /* Adjusted to maintain aspect ratio */
  border-radius: 8px;
}

.controls {
  display: flex;
  gap: 10px;
  margin-top: 10px;
}

.chat {
  border-radius: 8px;
  background-color: #f9f9f9 !important;
  padding: 10px;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1) !important;
}

/* For Participants */
.participants-scroll {
  max-height: 500px;
  /* Set the maximum height */
  overflow-y: auto;
  /* Enable vertical scrolling */
}

/* For Messages */
.chat-scroll {
  max-height: 300px;
  /* Set the maximum height */
  overflow-y: auto;
  /* Enable vertical scrolling */
}

/* For Participants */
.participants ul {
  list-style: none;
  padding: 0;
  margin: 0;
}

.participants li {
  display: flex;
  align-items: center;
  margin-bottom: 10px;
}

.participants img {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  margin-right: 10px;
}

.participant-name {
  font-weight: bold;
}

.message {
  align-items: flex-start;
  /* Align items at the start of the flex container */
  margin-bottom: 10px;
}

.user-info {
  display: flex;
  align-items: center;
  /* Align user image and name vertically */
  margin-right: 10px;
}

.user-info img {
  width: 30px;
  height: 30px;
  border-radius: 50%;
  margin-right: 5px;
  /* Adjust spacing */
}

.user-name {
  font-weight: bold;
}

.message-content {
  background-color: #fff;
  padding: 8px;
  border-radius: 8px;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
  margin-top: 2px;
  /* Add margin between user info and message */
}
</style>
<style>
/* Reset some default styles */
textarea,
button {
  margin: 0;
  padding: 0;
  border: none;
  outline: none;
  font-family: Arial, sans-serif;
}

/* Container styles */

/* Title styles */

/* Button styles */
.feedback-button {
  display: flex;
  justify-content: center;
  align-items: center;
  background-color: #edf2f7 !important;
  color: #4a5568 !important;
  border: 1px solid #cbd5e0 !important;
  border-radius: 0.25rem;
  padding: 0.5rem;
  transition: background-color 0.3s, border-color 0.3s, color 0.3s;
  margin-right: 5px;
}

.feedback-button:hover {
  background-color: #e2e8f0 !important;
  border-color: #a0aec0 !important;
  color: #2d3748 !important;
}

/* Spacer styles */
.feedback-spacer {
  grid-column: span 2;
}
.link {
display: flex;
align-items: center;
}

.link_left {
justify-content: flex-start;
}

.link_center {
justify-content: center;
}

.link_right {
justify-content: flex-end;
}

.button {
display: inline-flex;
align-items: center;
justify-content: center;
padding: 10px;
margin: 5px;
background-color: #edf2f7;
border: 1px solid #292d32;
border-radius: 5px;
cursor: pointer;
transition: background-color 0.3s, border-color 0.3s, color 0.3s;
}

.button svg {
width: 20px;
height: 20px;
fill: #292d32;
stroke: #292d32;
}
.tooltip {
position: relative;
display: inline-block;
opacity: 100 !important;
}

.tooltip-text {
visibility: hidden;
width: auto;
background-color: #333;
color: #fff;
text-align: center;
border-radius: 5px;
padding: 5px;
position: absolute;
z-index: 1;
bottom: 110%;
left: 50%;
transform: translateX(-50%);
opacity: 0;
transition: opacity 0.2s, visibility 0.2s;
}

.tooltip:hover .tooltip-text {
visibility: visible;
opacity: 1;
}

</style>
<script>
function copyToClipboard() {
const roomId = "{{room.room_id}}"; // Replace with your actual room_id
const currentUrl = "http://127.0.0.1:8000";
const textToCopy = currentUrl + "/join/" + roomId +"/";

navigator.clipboard.writeText(textToCopy)
  .then(() => {
    showNotification();
  })
  .catch(error => {
    console.error("Error copying text:", error);
  });
}

function showNotification() {
const notification = document.getElementById("notification");
notification.classList.add("active");

setTimeout(() => {
  notification.classList.remove("active");
}, 5000);
}

</script>
<style>
.notification {
position: fixed;
top: 20px;
right: 20px; /* Adjust the distance from the top and right as needed */
background-color: #333;
color: white;
padding: 10px 20px;
border-radius: 5px;
opacity: 0;
transition: opacity 0.5s;
z-index: 1000;
}

.notification.active {
opacity: 1;
}


</style>
<style>
/* Style for the popup container */
.popup-dialog {
display: none;
position: fixed;
top: 50%;
left: 50%;
transform: translate(-50%, -50%);
background-color: white;
padding: 20px;
border-radius: 5px;
box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
z-index: 1000;
}

/* Style for the overlay background */
.overlay {
display: none;
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background-color: rgba(0, 0, 0, 0.5);
z-index: 900;
}

</style>
<style>
  
  /* Mobile Styles */
  @media screen and (max-width: 768px) {
    .app-container {
      display: block;
    }
  
    .sidebar, .video-container{
      width: 100%;
    }
    .right-sidebar{
      width: 90%;
      
    }
    .left-sidebar{
      width: 90%;
    }
  
    .camera-controls {
    position: fixed;

  }
  .chat-scroll {
    max-height: 100px;
    /* Set the maximum height */
  }
  .feedback-container{
height: 90vh;
margin-bottom: 45px;
  }
  }
  
  
  </style>
{% else %}
<div class="slider-area">
  <div class="slider-height2 slider-bg2 d-flex align-items-center">
  </div>
</div>
<main class="h-full pb-16 overflow-y-auto">
  <!-- Remove everything INSIDE this div to a really blank page -->
  <div class="container">
    <div class="comment-form">
      <h4>SIGN IN TO PARTICIPATE
      </h4>
      <form class="form-contact comment_form" action="" id="commentForm" method="post">
        {% csrf_token %}
        <div class="row">
          <div class="col-sm-6">
            <div class="form-group">
              <input class="form-control" name="name" id="name" type="text" placeholder="Name">
            </div>
          </div>
          <div class="col-sm-6">
            <div class="form-group">
              <input class="form-control" name="email" id="email" type="email" placeholder="Email">
            </div>
          </div>
        </div>
        <div class="form-group">
          <button type="submit" class="button button-contactForm btn_1 boxed-btn">Submit</button>
        </div>
      </form>
    </div>

  </div>
</main>
<style>
  .comment-form{
    width: 50%;
    margin: 20px auto;
    background-color: #fbf9ff;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    padding: 20px;
  }
  @media screen and (max-width: 768px){
    .comment-form{
    width: 100%;
  }
  }
</style>
{% endif %}
{% endblock %}